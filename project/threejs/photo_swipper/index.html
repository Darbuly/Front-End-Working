<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <style>
        * {
            margin: 0;
            padding: 0;
        }
        body {
            margin: 0;
            background-color: #fff;
            color: #fff;
            font-family: Monospace;
            font-size: 13px;
            line-height: 24px;
            overscroll-behavior: none;
        }

  
        #menu {
				position: absolute;
				bottom: 20px;
				width: 100%;
				text-align: center;
			}


        #container {
            background-color: #000;
        }    


        .element {
				width: 488px;
				height: 275px;
				box-shadow: 0px 0px 12px rgba(0,255,255,0.5);
				border: 1px solid rgba(127,255,255,0.25);
				text-align: center;
				line-height: normal;
				cursor: default;
			}

            button {
				color: rgba(127,255,255,0.75);
				background: transparent;
				outline: 1px solid rgba(127,255,255,0.75);
				border: 0px;
				padding: 5px 10px;
				cursor: pointer;
			}

			button:hover {
				background-color: rgba(0,255,255,0.5);
			}

			button:active {
				color: #000000;
				background-color: rgba(0,255,255,0.75);
			}
    </style>
</head>
<body>
    <div id="container"></div>

    <div id="menu">
        <button id="last">LAST</button>
        <button id="next">NEXT</button>
    </div>

</body>

		<!-- Import maps polyfill -->
		<!-- Remove this when import maps will be widely supported 兼容import map 写法 -->
		<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>

        <script type="importmap">
			{
				"imports": {
					"three": "../../../lib/threejs/three.module.js",
					"three/addons/": "../../../lib/threejs/jsm/"
				}
			}
		</script>

        
		<script type="module">

            import * as THREE from 'three';

            //借助TWEEN.js快速创建补间动画，可以非常方便的控制机械、游戏角色运动
            import { TWEEN } from 'three/addons/libs/tween.module.min.js';

            //轨迹球控制器（TrackballControls）
            import { TrackballControls } from 'three/addons/controls/TrackballControls.js';

            //CSS3DRenderer用于通过CSS3的transform属性， 将层级的3D变换应用到DOM元素上。
            import { CSS3DRenderer, CSS3DObject } from 'three/addons/renderers/CSS3DRenderer.js';

            const pos = [
			    [0,0,10],
                [-10,0,0],
                [-5,0,-10],
                [5,0,-10],
                [10,0,0]
			];
            const rotation = [];

            const s = 60;//缩放系数
            const duration = 500;//过渡时间

            const objects = [];
			let camera, scene, renderer;
			let controls;

            init_3d_dom(800,400);
            animate();

            function init_3d_dom(Width,Height){

                			//创建透视摄像机
				camera = new THREE.PerspectiveCamera( 40, Width / Height, 1, 10*s );
				//调整透视摄像机z轴
				camera.position.z = 30*s;
                scene = new THREE.Scene();

                //创建定位图片

                for(let i=0;i<pos.length;i++){

                    const element = document.createElement( 'div' );
					element.className = 'element';
					element.style.backgroundColor = 'rgba(0,127,127,' + ( Math.random() * 0.5 + 0.25 ) + ')';

                    const objectCSS = new CSS3DObject( element );

                    objectCSS.position.x = ( pos[i][0]*s ) ;
                    objectCSS.position.y = 1;
					objectCSS.position.z =  ( pos[i][2]*s );
                    objectCSS.current_index = i;

                    scene.add( objectCSS );

                    objects.push( objectCSS );
                    rotation.push( objectCSS.rotation );


                }


                renderer = new CSS3DRenderer();
				renderer.setSize( Width, Height );
				document.getElementById( 'container' ).appendChild( renderer.domElement );

                
				controls = new TrackballControls( camera, renderer.domElement );
				controls.minDistance = 5.5*s;
				controls.maxDistance = 60*s;
				controls.addEventListener( 'change', render );

                const buttonNext = document.getElementById( 'next' );
				buttonNext.addEventListener( 'click', function () {
					transform( 'next', duration );
				} );

                const buttonLast = document.getElementById( 'last' );
				buttonLast.addEventListener( 'click', function () {
					transform( 'last', duration );
				} );

                window.addEventListener( 'resize', function(){
                    camera.aspect = Width / Height;
                    camera.updateProjectionMatrix();
                    renderer.setSize( Width, Height );
                    render();
                } );

            }
            function transform( direction, duration ) {

                TWEEN.removeAll();

                console.log('direction',direction)

                switch(direction){
                    case 'next':
                        for ( let i = 0; i < objects.length; i ++ ) {
                            const object = objects[ i ];
                            let last_index = object.current_index;
                            if(last_index == pos.length-1) last_index = -1;//归0
                            const next_pos = pos[last_index + 1];
                            const next_rotation = rotation[last_index + 1];
                            object.current_index = last_index + 1;
                            new TWEEN.Tween( object.position )
                                .to( { x: next_pos[0]*s , y:  next_pos[1]*s, z: next_pos[2]*s }, Math.random() * duration + duration )
                                .easing( TWEEN.Easing.Exponential.InOut )
                                .start();

                            new TWEEN.Tween( object.rotation )
                                .to( {x: next_rotation.x , y:  next_rotation.y, z: next_rotation.z  }, Math.random() * duration + duration )
                                .easing( TWEEN.Easing.Exponential.InOut )
                                .start();

                        }
                        break;

                    case 'last':
                        for ( let i = 0; i < objects.length; i ++ ) {
                            const object = objects[ i ];
                            let last_index = object.current_index;
                            if(last_index == 0) last_index = pos.length;
                            const next_pos = pos[last_index - 1];
                            const next_rotation = rotation[last_index - 1];
                            object.current_index = last_index - 1;
                            new TWEEN.Tween( object.position )
                                .to( { x: next_pos[0]*s , y:  next_pos[1]*s, z: next_pos[2]*s }, Math.random() * duration + duration )
                                .easing( TWEEN.Easing.Exponential.InOut )
                                .start();

                            new TWEEN.Tween( object.rotation )
                                .to( {x: next_rotation.x , y:  next_rotation.y, z: next_rotation.z  }, Math.random() * duration + duration )
                                .easing( TWEEN.Easing.Exponential.InOut )
                                .start();

                        }
                    break;

                }


                new TWEEN.Tween( this )
                    .to( {}, duration * 2 )
                    .onUpdate( render )
                    .start();

            }

            
			function animate() {

                requestAnimationFrame( animate );

                TWEEN.update();

                controls.update();

            }


            function render() {

                renderer.render( scene, camera );

            }

        </script>
</html>